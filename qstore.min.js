var qstore=function(){var e;var t;var n;var r;var i={};var s={};var o;var u=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};var a=function(){var e="";var t=this;for(var n=0;n<8;n++){e+=u()}return e};var f=function(e){var t=/function (.{1,})\(/;var n=t.exec(e.constructor.toString());var r=n&&n.length>1?n[1]:"";return r};var l={PropertyFilter:function(e,t,n){return{name:e,op:t,val:n}},detect:function(){var t=this;if(window.indexedDB){e=window.indexedDB}return{done:function(t){t(e);return this},error:function(e){return this}}},init:function(i,s){console.log("init");var o=this;var u=i.toString();var a;var f;var l;r=s;if(u=="[object Object]"){u="[object IDBFactory]"}switch(u){case"[object IDBFactory]":if(t){t.close();n+=1;a=i.open(s,n)}else{a=i.open(s)}a.onerror=function(e){console.log(e);if(l){l(e.target.error.message)}};a.onblocked=function(e){console.log("Please close all other tabs with this site open!")};a.onsuccess=function(r){console.log("onsuccess");t=r.target.result;n=t.version+1;f(e)};a.onupgradeneeded=function(e){console.log("onupgradeneeded");t=e.target.result;o.initSchema()};break;default:break}return{done:function(e){f=e;return this},error:function(e){l=e;return this}}},define:function(e,n){function r(){this.id=a();this._storeName=e;this._lastChange=(new Date).getTime();this._storeVal={};this._storeUrl="";for(var t in n){switch(n[t]){case"TEXT":this._storeVal[t]="";break;case"INT":this._storeVal[t]=0;break;case"BOOL":this._storeVal[t]=false;break;default:this._storeVal[t]=""}(function(e,t){Object.defineProperty(t,e,{get:function(){return t._storeVal[e]},set:function(n){t._storeVal[e]=n}})})(t,this)}}i[e]={};i[e]._storeSchema=n;r.enableSync=function(e){self._storeUrl=e};r.syncAll=function(t,n,r){var s=this;if(n){(function(e,t){o.all().filter("entity","=",e).list(function(n){if(n.length===0){var r=new o;r.entity=e;r.localDate=0;r.serverDate=0;r.serverPushDate=0;qstore.add(r);qstore.flush(function(){t(r)})}else{t(n[0])}})})(e,function(t){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState==4){if(r.status==200){if(r.responseText){var u=JSON.parse(r.responseText);s.all().filter("_lastChange",">",t.localDate).list(function(r){var a=[];for(var f=0;f<r.length;f++){var l={id:r[f].id};for(var c in i[e]._storeSchema){l[c]=r[f][c]}a.push(l)}var h=new XMLHttpRequest;h.onreadystatechange=function(){if(h.readyState==4){if(h.status==200){if(h.responseText){var t=JSON.parse(h.responseText);if(t.status=="ok"){(function(t,n){var r=0;if(t.updates.length===0){n();return}for(var o=0;o<t.updates.length;o++){(function(t,o){s.all().filter("id","=",t.id).list(function(u){if(u.length==1){for(var a in i[e]._storeSchema){u[0][a]=t[a]}}else{var f=new s;f.id=t.id;for(var l in i[e]._storeSchema){f[l]=t[l]}qstore.add(f)}r++;if(r==o){n()}})})(t.updates[o],t.updates.length)}})(u,function(){o.all().filter("entity","=",e).list(function(e){if(e.length==1){e[0].localDate=(new Date).getTime();e[0].serverDate=u.now;e[0].serverPushDate=t.now;qstore.flush(function(){n()})}})})}}}}};h.open("POST",self._storeUrl+"?since="+t.serverDate,true);h.setRequestHeader("Content-type","application/json");h.send(JSON.stringify(a));console.log("postItems");console.log(a)})}}}};r.open("GET",self._storeUrl+"?since="+t.serverDate,true);r.send()})}};r.remove=function(n){console.log("remove");console.log(n);var r=t.transaction([e],"readwrite");var i=r.objectStore(e);var s=i.delete(n.id);s.onsuccess=function(e){}};r.destroyAll=function(){console.log("destroyAll");var n=t.transaction([e],"readwrite");var r=n.objectStore(e);var i=r.openCursor();i.onerror=function(e){console.log(e)};i.onsuccess=function(e){var t=e.target.result;if(t){t.delete();t.continue()}}};r.all=function(){var r=this;var i={filterCollection:[],filterKey:null,filter:function(e,t,n){i.filterCollection=[];if(e=="id"){switch(t){case"=":i.filterKey=IDBKeyRange.only(n);break;default:break}}else{var r=new qstore.PropertyFilter(e,t,n);i.filterCollection.push(r)}return i},and:function(e){if(e.name=="id"){switch(e.op){case"=":i.filterKey=IDBKeyRange.only(e.val);break;default:break}}else{i.filterCollection.push(e)}return i},list:function(r){var s=t.transaction([e],"readwrite");var o=s.objectStore(e);var u=[];var a;if(i.filterKey){a=o.openCursor(i.filterKey)}else{a=o.openCursor()}a.onerror=function(e){console.log(e)};a.onsuccess=function(t){var s=t.target.result;if(s){var o=s.value;var a=function(e){for(var t=0;t<i.filterCollection.length;t++){var n=i.filterCollection[t].name;switch(i.filterCollection[t].op){case"=":if(e[n]!=i.filterCollection[t].val){return true}break;case">":if(e[n]>i.filterCollection[t].val){return false}else{return true}break;default:break}}return false}(o);if(!a){var f=function(t){this.id=t.id;this._storeName=e;this._storeVal={};for(var r in n){switch(n[r]){case"TEXT":this._storeVal[r]=t[r];break;case"INT":this._storeVal[r]=t[r];break;case"BOOL":this._storeVal[r]=t[r];break;default:this._storeVal[r]=t[r]}(function(e,t){Object.defineProperty(e,t,{get:function(){return e._storeVal[t]},set:function(n){e._storeVal[t]=n;console.log("set");console.log(e._storeVal.task);console.log(e._storeVal.done);qstore.update(e)}})})(this,r)}};u.push(new f(o))}s.continue()}else{r(u)}}}};return i};return r},schemaSync:function(n){console.log("schemaSync");o=qstore.define("_Sync",{entity:"TEXT",localDate:"INT",serverDate:"INT",serverPushDate:"INT"});var s=false;for(var u in i){if(!t.objectStoreNames.contains(u)){s=true;break}}if(s){qstore.init(e,r).done(function(){if(n){n()}})}else{n()}},initSchema:function(){console.log("initSchema");for(var e in i){if(!t.objectStoreNames.contains(e)){t.createObjectStore(e,{keyPath:"id"})}}},add:function(e){console.log("add");if(typeof s[e._storeName]=="undefined"){s[e._storeName]=[]}e._op="add";s[e._storeName].push(e)},remove:function(e){if(typeof s[e._storeName]=="undefined"){s[e._storeName]=[]}e._op="delete";s[e._storeName].push(e)},update:function(e){console.log("update");console.log(e);if(typeof s[e._storeName]=="undefined"){s[e._storeName]=[]}e._op="update";for(var t=0;t<s[e._storeName].length;t++){if(s[e._storeName][t].id==e.id){e._lastChange=(new Date).getTime();for(var n in i[s[e._storeName][t]._storeName]._storeSchema){e._storeVal[n]=s[e._storeName][t][n]}return}}s[e._storeName].push(e)},flush:function(e){console.log("flush");console.log(JSON.stringify(s));var n=this;for(var r in s){if(s.hasOwnProperty(r)){var o=t.transaction([r],"readwrite");var u=o.objectStore(r);for(var a=0;a<s[r].length;a++){var f={};var l;for(var c in i[s[r][a]._storeName]._storeSchema){f[c]=s[r][a][c]}switch(s[r][a]._op){case"add":f.id=s[r][a].id;f._lastChange=s[r][a]._lastChange;console.log("flushItem");console.log(f);l=u.add(f);break;case"update":f.id=s[r][a].id;f._lastChange=s[r][a]._lastChange;l=u.put(f);break;case"delete":f.id=s[r][a].id;f._lastChange=s[r][a]._lastChange;l=u.delete(f.id);break;default:break}l.onsuccess=function(){console.log("success")};l.onerror=function(e){console.log(e.target);console.log("error")}}}}for(var h in s){delete s[h]}if(e){e()}}};return l}()
