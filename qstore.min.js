var qstore=function(){var e;var t;var n;var r={};var i={};var s;var o=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};var u=function(){var e="";var t=this;for(var n=0;n<8;n++){e+=o()}return e};var a=function(e){var t=/function (.{1,})\(/;var n=t.exec(e.constructor.toString());var r=n&&n.length>1?n[1]:"";return r};return{PropertyFilter:function(e,t,n){return{name:e,op:t,val:n}},detect:function(){var t=this;if(window.indexedDB){e=window.indexedDB}return{done:function(t){t(e);return this},error:function(e){return this}}},init:function(r,i){console.log("init");var s=this;var o=r.toString();var u;var a;var f;n=i;if(!localStorage.dbVer){localStorage.dbVer=1}if(o=="[object Object]"){o="[object IDBFactory]"}switch(o){case"[object IDBFactory]":if(t){localStorage.dbVer=parseInt(t.version)+1;t.close()}var l=parseInt(localStorage.dbVer);u=r.open(i,l);u.onerror=function(e){console.log(e);if(f){f(e.target.error.message)}};u.onblocked=function(e){console.log("Please close all other tabs with this site open!")};u.onsuccess=function(n){console.log("onsuccess");t=n.target.result;a(e)};u.onupgradeneeded=function(e){console.log("onupgradeneeded");t=e.target.result;s.initSchema()};break;default:break}return{done:function(e){a=e;return this},error:function(e){f=e;return this}}},define:function(n,i){function o(){this.id=u();this._storeName=n;this._lastChange=(new Date).getTime();this._storeVal={};this._storeUrl="";for(var e in i){(function(e,t){Object.defineProperty(t,e,{get:function(){return t._storeVal[e]},set:function(n){t._storeVal[e]=n}})})(e,this);switch(i[e]){case"TEXT":this._storeVal[e]="";break;case"INT":this._storeVal[e]=0;break;case"BOOL":this._storeVal[e]=false;break;default:this._storeVal[e]=""}}}r[n]={};r[n]._storeSchema=i;o.enableSync=function(e){self._storeUrl=e};o.syncAll=function(e,t,i){var o=this;if(t){(function(e,t){s.all().filter("entity","=",e).list(function(n){if(n.length==0){var r=new s;r.entity=e;r.localDate=0;r.serverDate=0;r.serverPushDate=0;qstore.add(r);qstore.flush(function(){t(r)})}else{t(n[0])}})})(n,function(e){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(i.readyState==4){if(i.status==200){if(i.responseText){var u=JSON.parse(i.responseText);o.all().filter("_lastChange",">",e.localDate).list(function(i){var a=[];for(var f=0;f<i.length;f++){var l={id:i[f].id};for(var c in r[n]._storeSchema){l[c]=i[f][c]}a.push(l)}var h=new XMLHttpRequest;h.onreadystatechange=function(){if(h.readyState==4){if(h.status==200){if(h.responseText){var e=JSON.parse(h.responseText);if(e.status=="ok"){(function(e,t){var i=0;if(e.updates.length==0){t();return}for(var s=0;s<e.updates.length;s++){(function(e,s){o.all().filter("id","=",e.id).list(function(u){if(u.length==1){for(var a in r[n]._storeSchema){u[0][a]=e[a]}}else{var f=new o;f.id=e.id;for(var a in r[n]._storeSchema){f[a]=e[a]}qstore.add(f)}i++;if(i==s){t()}})})(e.updates[s],e.updates.length)}})(u,function(){s.all().filter("entity","=",n).list(function(n){if(n.length==1){n[0].localDate=(new Date).getTime();n[0].serverDate=u.now;n[0].serverPushDate=e.now;qstore.flush(function(){t()})}})})}}}}};h.open("POST",self._storeUrl+"?since="+e.serverDate,true);h.setRequestHeader("Content-type","application/json");h.send(JSON.stringify(a));console.log("postItems");console.log(a)})}}}};i.open("GET",self._storeUrl+"?since="+e.serverDate,true);i.send()})}};o.remove=function(t){var r=e.transaction([n],"readwrite");var i=r.objectStore(n);var s=i.delete(t.id);s.onsuccess=function(e){}};o.destroyAll=function(){console.log("destroyAll");var e=t.transaction([n],"readwrite");var r=e.objectStore(n);var i=r.openCursor();i.onerror=function(e){console.log(e)};i.onsuccess=function(e){var t=e.target.result;if(t){t.delete();t.continue()}}};o.all=function(){var e=this;var r={filterCollection:[],filterKey:null,filter:function(e,t,n){r.filterCollection=[];if(e=="id"){switch(t){case"=":r.filterKey=IDBKeyRange.only(n);break;default:break}}else{var i=new qstore.PropertyFilter(e,t,n);r.filterCollection.push(i)}return r},and:function(e){if(e.name=="id"){switch(e.op){case"=":r.filterKey=IDBKeyRange.only(e.val);break;default:break}}else{r.filterCollection.push(e)}return r},list:function(e){var s=t.transaction([n],"readwrite");var o=s.objectStore(n);var u=[];var a;if(r.filterKey){a=o.openCursor(r.filterKey)}else{a=o.openCursor()}a.onerror=function(e){console.log(e)};a.onsuccess=function(t){var s=t.target.result;if(s){var o=s.value;var a=function(e){for(var t=0;t<r.filterCollection.length;t++){var n=r.filterCollection[t].name;switch(r.filterCollection[t].op){case"=":if(e[n]!=r.filterCollection[t].val){return true}break;case">":if(e[n]>r.filterCollection[t].val){return false}else{return true}break;default:break}}return false}(o);if(!a){var f=new function(){var e=this;e.id=o.id;e._storeName=n;e._storeVal={};for(key in i){(function(e,t){Object.defineProperty(t,e,{get:function(){return t._storeVal[e]},set:function(n){t._storeVal[e]=n;qstore.update(t)}})})(key,this);switch(i[key]){case"TEXT":e._storeVal[key]=o[key];break;case"INT":e._storeVal[key]=o[key];break;case"BOOL":e._storeVal[key]=o[key];break;default:e._storeVal[key]=o[key]}}};u.push(f)}s.continue()}else{e(u)}}}};return r};return o},schemaSync:function(i){console.log("schemaSync");s=qstore.define("_Sync",{entity:"TEXT",localDate:"INT",serverDate:"INT",serverPushDate:"INT"});var o=false;for(var u in r){if(!t.objectStoreNames.contains(u)){o=true;break}}if(o){qstore.init(e,n).done(function(){if(i){i()}})}else{i()}},initSchema:function(){console.log("initSchema");for(var e in r){if(!t.objectStoreNames.contains(e)){t.createObjectStore(e,{keyPath:"id"})}}},add:function(e){console.log("add");if(typeof i[e._storeName]=="undefined"){i[e._storeName]=[]}e._op="add";i[e._storeName].push(e)},remove:function(e){if(typeof i[e._storeName]=="undefined"){i[e._storeName]=[]}e._op="delete";i[e._storeName].push(e)},update:function(e){console.log("update");console.log(e);if(typeof i[e._storeName]=="undefined"){i[e._storeName]=[]}e._op="update";for(var t=0;t<i[e._storeName].length;t++){if(i[e._storeName][t].id==e.id){e._lastChange=(new Date).getTime();for(var n in r[i[e._storeName][t]._storeName]._storeSchema){e._storeVal[n]=i[e._storeName][t][n]}return}}i[e._storeName].push(e)},flush:function(e){console.log("flush");console.log(JSON.stringify(i));var n=this;for(var s in i){if(i.hasOwnProperty(s)){var o=t.transaction([s],"readwrite");var u=o.objectStore(s);for(var a=0;a<i[s].length;a++){var f={};var l;for(var c in r[i[s][a]._storeName]._storeSchema){f[c]=i[s][a][c]}switch(i[s][a]._op){case"add":f.id=i[s][a].id;f._lastChange=i[s][a]._lastChange;console.log("flushItem");console.log(f);l=u.add(f);break;case"update":f.id=i[s][a].id;f._lastChange=i[s][a]._lastChange;l=u.put(f);break;case"delete":f.id=i[s][a].id;f._lastChange=i[s][a]._lastChange;l=u.delete(f.id);break;default:break}l.onsuccess=function(){console.log("success")};l.onerror=function(e){console.log(e.target);console.log("error")}}}}for(var s in i){delete i[s]}if(e){e()}}}}()
