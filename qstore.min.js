var qstore=function(){var e;var t;var n;var r={};var i={};var s;var o=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};var u=function(){var e="";var t=this;for(var n=0;n<8;n++){e+=o()}return e};var a=function(e){var t=/function (.{1,})\(/;var n=t.exec(e.constructor.toString());var r=n&&n.length>1?n[1]:"";return r};var f={PropertyFilter:function(e,t,n){return{name:e,op:t,val:n}},detect:function(){var t=this;if(window.indexedDB){e=window.indexedDB}return{done:function(t){t(e);return this},error:function(e){return this}}},init:function(r,i){console.log("init");var s=this;var o=r.toString();var u;var a;var f;n=i;if(!localStorage.dbVer){localStorage.dbVer=1}if(o=="[object Object]"){o="[object IDBFactory]"}switch(o){case"[object IDBFactory]":if(t){localStorage.dbVer=parseInt(t.version)+1;t.close()}var l=parseInt(localStorage.dbVer);u=r.open(i,l);u.onerror=function(e){console.log(e);if(f){f(e.target.error.message)}};u.onblocked=function(e){console.log("Please close all other tabs with this site open!")};u.onsuccess=function(n){console.log("onsuccess");t=n.target.result;a(e)};u.onupgradeneeded=function(e){console.log("onupgradeneeded");t=e.target.result;s.initSchema()};break;default:break}return{done:function(e){a=e;return this},error:function(e){f=e;return this}}},define:function(e,n){function i(){this.id=u();this._storeName=e;this._lastChange=(new Date).getTime();this._storeVal={};this._storeUrl="";for(var t in n){switch(n[t]){case"TEXT":this._storeVal[t]="";break;case"INT":this._storeVal[t]=0;break;case"BOOL":this._storeVal[t]=false;break;default:this._storeVal[t]=""}(function(e,t){Object.defineProperty(t,e,{get:function(){return t._storeVal[e]},set:function(n){t._storeVal[e]=n}})})(t,this)}}r[e]={};r[e]._storeSchema=n;i.enableSync=function(e){self._storeUrl=e};i.syncAll=function(t,n,i){var o=this;if(n){(function(e,t){s.all().filter("entity","=",e).list(function(n){if(n.length===0){var r=new s;r.entity=e;r.localDate=0;r.serverDate=0;r.serverPushDate=0;qstore.add(r);qstore.flush(function(){t(r)})}else{t(n[0])}})})(e,function(t){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(i.readyState==4){if(i.status==200){if(i.responseText){var u=JSON.parse(i.responseText);o.all().filter("_lastChange",">",t.localDate).list(function(i){var a=[];for(var f=0;f<i.length;f++){var l={id:i[f].id};for(var c in r[e]._storeSchema){l[c]=i[f][c]}a.push(l)}var h=new XMLHttpRequest;h.onreadystatechange=function(){if(h.readyState==4){if(h.status==200){if(h.responseText){var t=JSON.parse(h.responseText);if(t.status=="ok"){(function(t,n){var i=0;if(t.updates.length===0){n();return}for(var s=0;s<t.updates.length;s++){(function(t,s){o.all().filter("id","=",t.id).list(function(u){if(u.length==1){for(var a in r[e]._storeSchema){u[0][a]=t[a]}}else{var f=new o;f.id=t.id;for(var l in r[e]._storeSchema){f[l]=t[l]}qstore.add(f)}i++;if(i==s){n()}})})(t.updates[s],t.updates.length)}})(u,function(){s.all().filter("entity","=",e).list(function(e){if(e.length==1){e[0].localDate=(new Date).getTime();e[0].serverDate=u.now;e[0].serverPushDate=t.now;qstore.flush(function(){n()})}})})}}}}};h.open("POST",self._storeUrl+"?since="+t.serverDate,true);h.setRequestHeader("Content-type","application/json");h.send(JSON.stringify(a));console.log("postItems");console.log(a)})}}}};i.open("GET",self._storeUrl+"?since="+t.serverDate,true);i.send()})}};i.remove=function(n){console.log("remove");console.log(n);var r=t.transaction([e],"readwrite");var i=r.objectStore(e);var s=i.delete(n.id);s.onsuccess=function(e){}};i.destroyAll=function(){console.log("destroyAll");var n=t.transaction([e],"readwrite");var r=n.objectStore(e);var i=r.openCursor();i.onerror=function(e){console.log(e)};i.onsuccess=function(e){var t=e.target.result;if(t){t.delete();t.continue()}}};i.all=function(){var r=this;var i={filterCollection:[],filterKey:null,filter:function(e,t,n){i.filterCollection=[];if(e=="id"){switch(t){case"=":i.filterKey=IDBKeyRange.only(n);break;default:break}}else{var r=new qstore.PropertyFilter(e,t,n);i.filterCollection.push(r)}return i},and:function(e){if(e.name=="id"){switch(e.op){case"=":i.filterKey=IDBKeyRange.only(e.val);break;default:break}}else{i.filterCollection.push(e)}return i},list:function(r){var s=t.transaction([e],"readwrite");var o=s.objectStore(e);var u=[];var a;if(i.filterKey){a=o.openCursor(i.filterKey)}else{a=o.openCursor()}a.onerror=function(e){console.log(e)};a.onsuccess=function(t){var s=t.target.result;if(s){var o=s.value;var a=function(e){for(var t=0;t<i.filterCollection.length;t++){var n=i.filterCollection[t].name;switch(i.filterCollection[t].op){case"=":if(e[n]!=i.filterCollection[t].val){return true}break;case">":if(e[n]>i.filterCollection[t].val){return false}else{return true}break;default:break}}return false}(o);if(!a){var f=function(t){this.id=t.id;this._storeName=e;this._storeVal={};for(var r in n){switch(n[r]){case"TEXT":this._storeVal[r]=t[r];break;case"INT":this._storeVal[r]=t[r];break;case"BOOL":this._storeVal[r]=t[r];break;default:this._storeVal[r]=t[r]}(function(e,t){Object.defineProperty(e,t,{get:function(){return e._storeVal[t]},set:function(n){e._storeVal[t]=n;console.log("set");console.log(e._storeVal.task);console.log(e._storeVal.done);qstore.update(e)}})})(this,r)}};u.push(new f(o))}s.continue()}else{r(u)}}}};return i};return i},schemaSync:function(i){console.log("schemaSync");s=qstore.define("_Sync",{entity:"TEXT",localDate:"INT",serverDate:"INT",serverPushDate:"INT"});var o=false;for(var u in r){if(!t.objectStoreNames.contains(u)){o=true;break}}if(o){qstore.init(e,n).done(function(){if(i){i()}})}else{i()}},initSchema:function(){console.log("initSchema");for(var e in r){if(!t.objectStoreNames.contains(e)){t.createObjectStore(e,{keyPath:"id"})}}},add:function(e){console.log("add");if(typeof i[e._storeName]=="undefined"){i[e._storeName]=[]}e._op="add";i[e._storeName].push(e)},remove:function(e){if(typeof i[e._storeName]=="undefined"){i[e._storeName]=[]}e._op="delete";i[e._storeName].push(e)},update:function(e){console.log("update");console.log(e);if(typeof i[e._storeName]=="undefined"){i[e._storeName]=[]}e._op="update";for(var t=0;t<i[e._storeName].length;t++){if(i[e._storeName][t].id==e.id){e._lastChange=(new Date).getTime();for(var n in r[i[e._storeName][t]._storeName]._storeSchema){e._storeVal[n]=i[e._storeName][t][n]}return}}i[e._storeName].push(e)},flush:function(e){console.log("flush");console.log(JSON.stringify(i));var n=this;for(var s in i){if(i.hasOwnProperty(s)){var o=t.transaction([s],"readwrite");var u=o.objectStore(s);for(var a=0;a<i[s].length;a++){var f={};var l;for(var c in r[i[s][a]._storeName]._storeSchema){f[c]=i[s][a][c]}switch(i[s][a]._op){case"add":f.id=i[s][a].id;f._lastChange=i[s][a]._lastChange;console.log("flushItem");console.log(f);l=u.add(f);break;case"update":f.id=i[s][a].id;f._lastChange=i[s][a]._lastChange;l=u.put(f);break;case"delete":f.id=i[s][a].id;f._lastChange=i[s][a]._lastChange;l=u.delete(f.id);break;default:break}l.onsuccess=function(){console.log("success")};l.onerror=function(e){console.log(e.target);console.log("error")}}}}for(var h in i){delete i[h]}if(e){e()}}};return f}()
